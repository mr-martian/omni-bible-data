#!/usr/bin/env python

import unicodedata
from xml.etree import ElementTree as ET
import glob

def clean(s):
    return ''.join(c for c in unicodedata.normalize('NFKD', s or '')
                   if unicodedata.category(c) == 'Lo')

bhsa_overrides = {
    84906: 'לכה',
    90015: 'תניאון',
    137649: 'לי',
    140165: 'בני',
    146165: 'גגה',
    149046: 'אלה',
    164664: 'פרת',
    168767: 'הציתוה',
    174631: 'רגלי',
    186762: 'לבו',
    196508: 'לך',
    196537: 'שכניך',
    196624: 'נשיך',
    196627: 'ו',
    196628: 'בניך',
    201016: 'שמטוה',
    208172: 'בניו',
    208604: 'יקחו',
    209324: 'יתנהו',
    222435: 'בם',
    238654: 'הוציאי',
    262407: 'לה',
    267523: 'חללוהו',
    275947: 'תעגבה',
    303637: 'גויי',
    356862: 'אלי',
    357097: 'אלי',
    365284: 'הביטה',
    370626: 'כשדאי',
    370726: 'כשדאי',
    372184: 'רביעאה',
    372208: 'עלאה',
    372370: 'עלאה',
    372647: 'עלאה',
    372650: 'אנשא',
    372719: 'מרי',
    372838: 'עלאה',
    372843: 'מרי',
    373064: 'עלאה',
    373583: 'עלאה',
    373662: 'שׁויו',
    373683: 'עלאה',
    373721: 'אנת',
    373841: 'כשדאה',
    374547: 'פרסאה',
    375087: 'עלאה',
    379698: 'ארכויא',
    379760: 'שׁוריא',
    380284: 'כסדאה',
    380750: 'נביא',
    383056: '??',
    384826: 'אחריו',
    384846: 'אחריו',
    419331: 'לכה',
}

# something weird in Deuteronomy
naar_plus_ah = [105544, 105552, 105563, 105660, 105665, 105724, 105758, 105794, 105817, 105824, 105849, 105859, 105881]
for wid in naar_plus_ah:
    bhsa_overrides[wid] = 'נערה'

def read_tf():
    def lines():
        with open('/home/daniel/text-fabric-data/etcbc/bhsa/tf/2021/g_cons_utf8.tf') as fin:
            for i in range(12):
                next(fin)
            for line in fin:
                yield clean(line.strip())
    for i, w in  enumerate(lines(), 1):
        yield (i, bhsa_overrides.get(i, w))

macula_overrides = {
    'o010140020171': 'צביים',
    'o010270030121': 'צידה',
    'o010270290042': 'ישתחו',
    'o010300110041': 'ב',
    'o010430280092': 'ישתחו',
    'o010490100121': 'שילה',
    'o020040020051': 'מ',
    'o020270110092': 'עמד',
    'o020280280052': 'טבעת',
    'o020320190152': 'יד',
    'o020370080161': 'קצוות',
    'o020390040081': 'קצוות',
    'o020390330141': 'בריח',
    'o030090220051': 'יד',
    'o030160210061': 'יד',
    'o030210050031': 'יקרחה',
    'o040120030041': 'ענו',
    'o040340040102': 'היה',
    'o050020330091': 'בנ',
    'o050050100072': 'ו',
    'o050070090151': 'מצות',
    'o050210070061': 'שפכה',
    'o050280270063': 'עפלים', # weird
    'o050280300061': 'ישגל', # weird
    'o050320130041': 'במותי',
    'o060020130101': 'אחותי',
    'o060030160111': 'ב',
    'o060040180031': 'ב',
    'o060050010282': 'נו',
    'o060060050061': 'ב',
    'o060060070022': 'יאמרו',
    'o060060130231': 'הולך',
    'o060070210022': 'אראה',
    'o060080160062': 'עיר',
    'o060090070022': 'יאמרו',
    'o060090070131': 'אכרות',
    'o060150040072': 'היה',
    'o060150470122': 'גבול',
    'o060150630071': 'יוכלו',
    'o060180120182': 'היה',
    'o060180140162': 'היה',
    'o060180190092': 'היה',
    'o060180190111': 'תצאותיו',
    'o060180240031': 'העמני',
    'o060190220052': 'שחצומ',
    'o060190290122': 'יהיו',
    'o060200080191': 'גלון',
    'o060210270141': 'גלון',
    'o060220070131': 'מ',
    'o060240030142': 'ארב',
    'o060240080022': 'אבאה',
    'o060240150211': 'ב',
    'o070010270151': 'ישב',
    'o070040110142': 'צענים',
    'o070090080101': 'מלוכ',
    'o070090120071': 'מלוכי',
    'o070110370212': 'רעיתי',
    'o070130170111': 'דברי',
    'o070160250041': 'כי',
    'o070160260102': 'הימש',
    'o070170020102': 'אתי',
    'o070190030093': 'ו',
    'o070190250221': 'ב',
    'o070210200022': 'יצו',
    'o090020160151': 'לו',
    'o090040130081': 'יך',
    'o090050060102': 'עפלים', # weird
    'o090050090221': 'עפלים', # weird
    'o090050120072': 'עפלים', # weird
    'o090060040131': 'עפלי', # weird
    'o090060050041': 'עפלי', # weird
    'o090070090073': 'ה',
    'o090090010052': 'בןימין',
    'o090100070041': 'תבאינה',
    'o090110060071': 'ב',
    'o090110090141': 'ב',
    'o090120100052': 'יאמר',
    'o090130190091': 'אמר',
    'o090140270232': 'תראנה',
    'o090140320022': 'יעש',
    'o090150160152': 'יאמרו',
    'o090170070022': 'חץ',
    'o090170230132': 'מערות',
    'o090180010123': 'ו',
    'o090180090041': 'עון',
    'o090200020091': 'לו',
    'o090200020101': 'עשה',
    'o090200240091': 'על',
    'o090200380142': 'חצי',
    'o090210140082': 'יתו',
    'o090220150042': 'שאול',
    'o090220170241': 'אזנו',
    'o090220180042': 'דויג',
    'o090220180111': 'דויג',
    'o090220220101': 'דויג',
    'o090240050161': 'איבי',
    'o090240090081': 'מן',
    'o090240190022': 'את',
    'o090250030181': 'כלבו',
    'o090250340142': 'תבאתי',
    'o090260220061': 'החנית',
    'o090270040091': 'יוסף',
    'o090270080083': 'גרזי',
    'o090280080171': 'קסומי',
    'o100010080062': 'יאמר',
    'o100010160051': 'דמי',
    'o100030020022': 'ילדו',
    'o100030030042': 'אביגל',
    'o100030250141': 'מבוא',
    'o100050020153': 'מבי',
    'o100050240031': 'ב',
    'o100100090141': 'בישראל',
    'o100110240022': 'יראו',
    'o100110240042': 'מוראים',
    'o100120090093': 'ו',
    'o100120240142': 'יקרא',
    'o100120310152': 'מלכן',
    'o100130080122': 'תלוש',
    'o100130370081': 'עמיחור',
    'o100140110092': 'הרבית',
    'o100140220272': 'ו',
    'o100150200051': 'אנוע',
    'o100150280052': 'עברות',
    'o100160020151': 'ול',
    'o100160100091': 'כי',
    'o100160100121': 'וכי',
    'o100160120052': 'עוני',
    'o100160230091': '',
    'o100170120042': 'אחת',
    'o100180080051': 'נפצית',
    'o100180120062': 'לא',
    'o100180130043': 'ו',
    'o100180200201': '',
    'o100190070201': 'לא',
    'o100190320121': 'ב',
    'o100190410111': 'ויעברו',
    'o100200140112': 'יקלהו',
    'o100200230112': 'כרי',
    'o100210040062': 'י',
    'o100210060021': 'ינתן',
    'o100210090101': 'שבעתי',
    'o100210090132': 'הם',
    'o100210090191': '',
    'o100210120231': 'תלו',
    'o100210210081': 'שמעי',
    'o100220080022': 'תגעש',
    'o100220150062': 'יהמם',
    'o100220330072': 'ו',
    'o100230080211': 'אחד',
    'o100230090111': '',
    'o100230130031': 'שלשים',
    'o100230180092': 'שלשי',
    'o100230200071': 'חי',
    'o100230200222': 'אריה',
    'o100230210071': 'אשר',
    'o100230370061': 'נשאי',
    'o100240160242': 'אורנה',
    'o100240180151': 'ארניה',
    'o110010270121': 'עבדי',
    'o110010370091': 'יהי',
    'o110010470131': 'אלהיך',
    'o110020240072': 'יושיבי',
    'o110040070181': '',
    'o110050170251': 'רגלו',
    'o110060160062': 'ירכותי',
    'o110070200121': '',
    'o110070230162': 'קוה',
    'o110070360071': 'ומסגרתי',
    'o110070450112': 'אהל',
    'o110080260071': 'דברי',
    'o110080480251': 'בנית',
    'o110090090182': 'ישתחו',
    'o110090180051': 'תמר',
    'o110120030052': 'יבאו',
    'o110120070022': 'ידבר',
    'o110120120022': 'יבו',
    'o110120210022': 'יבאו',
    'o110140020111': 'אתי',
    'o110150180151': '',
    'o110160260083': 'חטאתי',
    'o110170140181': 'תתן',
    'o110180360223': 'דברי',
    'o110190040111': 'אחת',
    'o110200410062': 'על',
    'o110210080091': 'הספרים',
    'o110210210031': 'מבי',
    'o110210290121': 'אבי',
    'o110220490031': 'עשר',
    'o110220490131': 'נשברה',
    'o120020160272': 'גיאות',
    'o120030240132': 'יבו',
    'o120040160071': 'אתי',
    'o120040230041': 'אתי',
    'o120040230061': 'הלכתי',
    'o120050120041': 'אבנה',
    'o120050180221': 'יסלחנא',
    'o120050250102': 'אן',
    'o120060250181': 'חרייונים',
    'o120070120241ה': 'ה',
    'o120070130171': 'ההמון',
    'o120070150151': 'בה',
    'o120080010131': 'אתי',
    'o120080170091': 'שנה',
    'o120090150282': 'גיד',
    'o120090370022': 'הית',
    'o120100270112': 'מחראות',
    'o120110010051': 'וראתה',
    'o120110020182': 'ממותתים',
    'o120110040092': 'מאיות',
    'o120110090042': 'מאיות',
    'o120110100052': 'מאיות',
    'o120110150072': 'מיאות',
    'o120110200131': '',
    'o120120100141': 'ב',
    'o120120120071': 'יד',
    'o120120120112': 'פקדים',
    'o120130060091': 'החטי',
    'o120140020151': 'יהועדין',
    'o120140060291': 'ימות',
    'o120140070071': 'המלח',
    'o120140130162': 'יבאו',
    'o120150250121': '',
    'o120160060152': 'ארמים',
    'o120160150022': 'יצוהו',
    'o120160170101': 'ואת',
    'o120170160111': 'שנים',
    'o120170210132': 'ידא',
    'o120170310141': 'אלה',
    'o120170310161': 'ספרים',
    'o120180270231': 'חריה',
    'o120180270271': 'ש', # ???
    'o120180270281': 'יני', # ???
    'o120190230072': 'רכב',
    'o120190310101': '',
    'o120200040061': 'העיר',
    'o120210120162': 'יו',
    'o120220050091': 'בבית',
    'o120230100071': 'בני',
    'o120230330081': 'ב',
    'o120240100041': 'עלה',
    'o120240140131': 'עשרה',
    'o120250170141': 'אמה',
    'o230030150021': 'מ',
    'o230030160101': 'נטוות',
    'o230100060133': 'שימ',
    'o230100130132': 'עתידתי',
    'o230100320091': 'בית',
    'o230130160081': 'תשגלנה',
    'o230180040071': 'אשקוטה',
    'o230230120111': 'כתיים',
    'o230230130131': 'בחיני',
    'o230260200141': 'יעבור',
    'o230280150161': 'עבר',
    'o230290110141': 'הספר',
    'o230300050031': 'הבאיש',
    'o230320150102': '',
    'o230360120221': 'חראיה',
    'o230360120261': 'שי',
    'o230360120271': 'ני',
    'o230370300172': 'אכול',
    'o230410230132': 'נרא',
    'o230420240042': 'משוסה',
    'o230440170061': 'יסגוד',
    'o230440240181': 'מי',
    'o230460110082': 'ו',
    'o230520050041': 'מי',
    'o230540160021': 'הן',
    'o230550130061': '',
    'o230600210092': 'ו',
    'o230650040092': 'פרק',
    'o230650070181': 'על',
    'o230660170071': 'אחד',
    'o240010050031': 'אצור',
    'o240020150111': 'נצתה',
    'o240020160052': 'תחפנס',
    'o240020200101': 'אעבד',
    'o240020240062': 'ו',
    'o240020250052': 'גורנ',
    'o240020270082': 'ני',
    'o240020330111': 'למדתי',
    'o240030020091': 'שגלת',
    'o240030040041': 'קראתי',
    'o240030050081': 'דברתי',
    'o240030070122': 'תראה',
    'o240040050071': 'ותקעו',
    'o240040190041': 'אחולה',
    'o240040190161': 'שמעתי',
    'o240040300022': 'אתי',
    'o240050060221': 'משבותי',
    'o240050070041': 'אסלוח',
    'o240080060172': 'מרצות',
    'o240090070031': 'שוחט',
    'o240100130101': '',
    'o240100170051': 'ישבתי',
    'o240140030041': 'צעורי',
    'o240150040032': 'זועה',
    'o240150090071': 'באה',
    'o240150110061': 'שרות',
    'o240170080121': 'ירא',
    'o240170190101': '',
    'o240170230121': 'שומע',
    'o240180030052': 'הן',
    'o240180030061': 'הו',
    'o240180100032': 'רעה',
    'o240180160051': 'שרוקת',
    'o240180230182': 'היו',
    'o240190150091': 'מבי',
    'o240210120232': 'הם',
    'o240220060211': 'נושבה',
    'o240220230021': 'ישבתי',
    'o240220230051': 'מקננתי',
    'o240230180132': 'י',
    'o240240090032': 'זועה',
    'o240250070081': 'הכעסו',
    'o240250130022': 'הבאיתי',
    'o240260060092': 'זאתה',
    'o240260180021': 'מיכיה',
    'o240280010102': 'שנת',
    'o240290140081': 'שבית',
    'o240290180082': 'זועה',
    'o240310210121': 'הלכתי',
    'o240310380031': '',
    'o240310390041': 'קוה',
    'o240310400072': 'שרמות',
    'o240320010092': 'שנת',
    'o240320230083': 'תרות',
    'o240320350271': 'החטי',
    'o240330080092': 'כול',
    'o240340110132': 'יכבישו',
    'o240340170302': 'זועה',
    'o240370190022': 'איו',
    'o240380110171': 'הסחבות',
    'o240380160111': 'אתאשר',
    'o240390120101': 'כיאם',
    'o240390160151': 'מבי',
    'o240400030151': '',
    'o240400160111': 'תעש',
    'o240410170051': 'כמוהם',
    'o240420060101': 'אנו',
    'o240420200031': 'התעתים',
    'o240430100271': 'שפרור',
    'o240430110022': 'באה',
    'o240460110101': 'הרביתי',
    'o240480040061': 'צעורי',
    'o240480050042': 'לחות',
    'o240480070161': 'יחד',
    'o240480270101': 'נמצאה',
    'o240480440022': 'ניס',
    'o240490250061': 'תהלה',
    'o240490280071': 'נבוכדראצור',
    'o240490300192': 'הם',
    'o240500060041': 'היה',
    'o240500060101': 'שובבי',
    'o240500080071': 'יצאו',
    'o240500150081': 'אשויתי',
    'o240500440121': 'ארוצ',
    'o240510030021': 'ידרךידרך',
    'o240510090021': 'רפאנו',
    'o240510130021': 'שכנתי',
    'o240510340022': 'נו',
    'o240520110131': 'בבית',
    'o240520210061': 'קומה',
    'o240520320101': '',
    'o260030150112': 'אשר',
    'o260040060082': 'ימוני',
    'o260060030163': 'גאית',
    'o260070020151': 'ארבעת',
    'o260080060081': 'מ',
    'o260090050091': 'על',
    'o260090110132': '',
    'o260140040331': 'בה',
    'o260140140081': 'דנאל',
    'o260140200031': 'דנאל',
    'o260160130061': 'ששי',
    'o260160130131': 'אכלתי',
    'o260160180091': 'נתתי',
    'o260160200142': 'תזנת',
    'o260160220071': 'זכרתי',
    'o260160250181': 'תזנת',
    'o260160310081': 'עשיתי',
    'o260160310131': 'הייתי',
    'o260160430051': 'זכרתי',
    'o260160430241': 'עשיתי',
    'o260160470061': 'עשיתי',
    'o260160510131': 'אחות',
    'o260160510181': 'עשיתי',
    'o260160590072': 'עשית',
    'o260180200211': '',
    'o260180280032': 'ישוב',
    'o260210280042': 'קסום',
    'o260230140111': 'כשדיים',
    'o260230420111': 'סובאים',
    'o260230430051': 'עת',
    'o260230430071': 'יזנה',
    'o260240020041': 'כתוב',
    'o260250070092': 'בג',
    'o260250090172': 'קריתמ',
    'o260270030042': 'ישבתי',
    'o260270060121': 'כתים',
    'o260270150112': 'הובנים',
    'o260280030052': 'דנאל',
    'o260290040031': 'חחיים',
    'o260290070042': 'כפך',
    'o260320320052': 'ו',
    'o260350090071': 'תישבנה',
    'o260350120161': 'שממה',
    'o260360130111': 'אתי',
    'o260360130141': 'גוי',
    'o260360140072': 'גוי',
    'o260360140101': 'תכשלי',
    'o260360150132': 'גוי',
    'o260370220151': 'יהיה',
    'o260400150052': 'יאתון',
    'o260410150112': 'אתוקי',
    'o260420160081': 'אמות',
    'o260430160023': 'אראיל',
    'o260440240062': 'שפט',
    'o260440240091': 'ושפט',
    'o260450030071': 'חמש',
    'o260460090341': 'יצאו',
    'o260460190182': 'ירכתם',
    'o260470080182': 'נרפאו',
    'o260470100031': 'יעמדו',
    'o260470120262': 'היו',
    'o260480160111': 'חמשחמש',
    'o280080120021': 'אכתוב',
    'o280090160071': 'בלי',
    'o280100100091': 'עינת',
    'o300080080152': 'נשקה',
    'o330010030101': 'במותי',
    'o330010100111': 'התפלשתי',
    'o330030020051': 'רעה',
    'o340010030052': 'גדול',
    'o340020010182': 'עבור',
    'o340020060052': 'הלכות',
    'o360020070181': 'שבות',
    'o370010080102': 'אכבד',
    'o380010040192': 'מעלילי',
    'o380010160152': 'קוה',
    'o380040020072': 'יאמר',
    'o380140020141': 'תשגלנה',
    'o190060040052': 'את',
    'o190100100071': 'חל',
    'o190170110042': 'ני',
    'o190170140092': 'צפינ',
    'o190180510021': 'מגדל',
    'o190210020081': 'יגיל',
    'o190260020051': 'צרופ',
    'o190300040082': 'יורד',
    'o190380210081': 'רדופ',
    'o190490150112': 'ציר',
    'o190510040021': 'הרבה',
    'o190590110032': 'ו',
    'o190590160031': 'ינועו',
    'o190710120081': 'חיש',
    'o190730020081': 'שפכה',
    'o190740060022': 'עת',
    'o190740110071': 'חוק',
    'o190890290031': 'אשמור',
    'o190900080021': 'שת',
    'o190920160081': 'עלת',
    'o191010050021': 'מלושני',
    'o191020240042': 'ו',
    'o191050280081': 'דברו',
    'o191260040051': 'שבות',
    'o191290030072': 'מענות',
    'o191390060021': 'פלאיה',
    'o191400100061': 'יכסו',
    'o191400130021': 'ידעת',
    'o180010040121': 'אחיתי',
    'o180010100031': 'את',
    'o180010210041': 'יצתי',
    'o180020070141': '',
    'o180060020062': 'הית',
    'o180060140021': 'מ', # TODO: these two words are maybe a 2-2 match?
    'o180060140022': 'רעהו',
    'o180060290072': 'שבי',
    'o180070010051': 'על',
    'o180150220072': 'צפו',
    'o180150310042': 'שו',
    'o180160160031': 'חמרמרה',
    'o180190290122': 'דין',
    'o180210130021': 'יבלו',
    'o180260120053': 'תובנת',
    'o180260140131': 'גבורת',
    'o180300110032': 'ו',
    'o180300220071': 'תשוה',
    'o180330280032': 'י',
    'o180330280073': 'י',
    'o180380120061': 'ידעת',
    'o180420020021': 'ידעת',
    'o180420110071': 'אחיתי',
    'o180420160092': 'ירא',
    'o200010270032': 'שאוה',
    'o200030150042': 'פניים',
    'o200060140081': 'מדנים',
    'o200060160071': 'תועבות',
    'o200080170032': 'יה',
    'o200080350041': 'מצאי',
    'o200110030071': 'ושד',
    'o200130200021': 'הלוך',
    'o200150140062': 'פני',
    'o200190040061': 'מ', # TODO: 2x2 again
    'o200190040062': 'רעהו',
    'o200190160081': 'יומת',
    'o200190190021': 'גרל',
    'o200200160081': 'נכרים',
    'o200200200072': 'אישון',
    'o200200210031': 'מבחלת',
    'o200210290081': 'יכין',
    'o200220030052': 'יסתר',
    'o200220080041': 'יקצור',
    'o200220110031': 'טהור',
    'o200220140081': 'יפול',
    'o200220200051': 'שלשום',
    'o200230060091': 'תתאו',
    'o200230240081': '',
    'o200230240111': 'וישמח',
    'o200230260081': 'תרצנה',
    'o200240010071': 'תתאו',
    'o200270100032': 'רעה',
    'o200270200032': 'אבדה',
    'o200270240091': '',
    'o200280080052': 'בתרבית',
    'o200280160071': 'שנאי',
    'o200300180062': 'ארבע',
    'o200310160071': 'נטע',
    'o200310180082': 'ליל',
    'o080010080111': 'יעשה',
    'o080030030051': 'שמלת',
    'o080030030082': 'ירדתי',
    'o080030040132': 'שכבתי',
    'o080030120041': 'כיאם',
    'o080030140031': 'מרגלת',
    'o080030140082': 'טרום',
    'o080040040212': 'אדע',
    'o080040050141': 'קניתי',
    'o080040060062': 'גאול',
    'o220010170051': 'רחיט',
    'o220020110042': 'סתו',
    'o220020130102': 'כי',
    'o220040090062': 'אחד',
    'o210060100151': 'שה',
    'o210070220101': 'את',
    'o210090040051': 'יבחר',
    'o210100030042': 'שה',
    'o210100100121': 'הכשיר',
    'o210100200191': 'הכנפים',
    'o210120060051': 'ירחק',
    'o250010060041': 'מן',
    'o250010110081': 'מחמודי',
    'o250010180111': '',
    'o250020020041': '',
    'o250020140121': 'שבית',
    'o250020190042': 'ליל',
    'o250030100061': 'אריה',
    'o250040030031': 'תנין',
    'o250040030131': 'כי',
    'o250040030132': 'ענים',
    'o250040120061': 'וכל',
    'o250040160121': '',
    'o250040170021': 'עודי',
    'o250040170022': 'נה',
    'o250040210061': 'יושבתי',
    'o250050030041': '',
    'o250050050061': '',
    'o250050070041': '',
    'o250050070061': '',
    'o250050210052': 'נשוב',
    'o170010160031': 'מומכן',
    'o170030040031': 'ב',
    'o170040070192': 'יהודיים',
    'o170080010132': 'יהודיים',
    'o170080070222': 'יהודיים',
    'o170080130132': 'יהודיים',
    'o170090150032': 'יהודיים',
    'o170090180023': 'יהודיים',
    'o170090190052': 'פרוזים',
    'o170090270032': 'קבל',
    'o170100010041': 'אחשרש',
    'o270010040071': 'מאום',
    'o270020090131': 'הזמנתון',
    'o270020220092': 'נהיר',
    'o270020330062': 'הון',
    'o270020330103': 'הון',
    'o270020380041': 'דארין',
    'o270020390061': 'ארעא',
    'o270020390101': 'תליתיא',
    'o270020400031': 'רביעיה',
    'o270020410062': 'הון',
    'o270020410113': 'הון',
    'o270020420042': 'הון',
    'o270020420073': 'הון',
    'o270020430021': '',
    'o270030030202': 'קאמין',
    'o270030050081': 'קיתרוס',
    'o270030070141': 'קיתרס',
    'o270030100021': 'אנתה',
    'o270030100151': 'קיתרס',
    'o270030150131': 'קיתרס',
    'o270030210071': 'פטישי',
    'o270030290121': 'שלה',
    'o270030310091': 'דארין',
    'o270040040031': 'עללין',
    'o270040040071': 'כשדיא',
    'o270040090141': 'ידרון',
    'o270040130041': 'אנוש',
    'o270040150082': 'אנתה',
    'o270040150232': 'אנתה',
    'o270040190021': 'אנתה',
    'o270040240082': 'חטי',
    'o270040320031': 'דארי',
    'o270040320122': 'דארי',
    'o270050050041': 'נפקו',
    'o270050070071': 'כשדיא',
    'o270050070262': 'המונכ',
    'o270050080031': 'עללין',
    'o270050080123': 'א',
    'o270050100091': 'עללת',
    'o270050130111': 'אנתה',
    'o270050160071': 'תוכל',
    'o270050160151': 'תוכל',
    'o270050160232': 'המונכ',
    'o270050180021': 'אנתה',
    'o270050190121': 'זאעין',
    'o270050210091': 'שׁויו',
    'o270050220022': 'אנתה',
    'o270050290082': 'המונכ',
    'o270060170171': 'אנתה',
    'o270060210181': 'אנתה',
    'o270060260111': 'דארין',
    'o270060270111': 'זאעין',
    'o270070070101': 'רביעיה',
    'o270070080102': 'הון',
    'o270070080161': 'אתעקרו',
    'o270070100101': 'אלפים',
    'o270070100141': 'רבון',
    'o270070190122': 'הון',
    'o270070200102': 'נפלו',
    'o270070230072': 'יא',
    'o270080110071': 'הרים',
    'o270090050041': 'והרשענו',
    'o270090180061': 'פקחה',
    'o270090240123': 'חתם',
    'o270090240141': 'חטאות',
    'o270100190102': 'כ',
    'o270110100142': 'יתגרו',
    'o270110120042': 'רום',
    'o270110180022': 'ישב',
    'o270110390091': 'הכיר',
    'o150020010101': 'נבוכדנצור',
    'o150020460051': 'שמלי',
    'o150030030112': 'יעל',
    'o150040040092': 'מבלהים',
    'o150040070121': 'ארתחששתא',
    'o150040090181': 'דהו',
    'o150040120162': 'באישת',
    'o150040120192': 'שׁורי',
    'o150040120211': 'אשכללו',
    'o150040230081': 'ארתחששתא',
    'o150050010042': 'אה',
    'o150050010091': 'נביאי',
    'o150050020171': 'נביאי',
    'o150050150041': 'אלה',
    'o150060170162': 'חטיא',
    'o150070250131': 'דאנין',
    'o150080140052': 'זבוד',
    'o150080170022': 'אוצאה',
    'o150080250022': 'אשקול',
    'o150100140081': 'ב??',
    'o150100370042': 'יעשׂו',
    'o150100350041': 'כלהי',
    'o150100370042': 'יעשו',
    'o150100430081': 'ידו',
    'o160010010081': 'כסלו',
    'o160010090152': 'הבואתי',
    'o160030150162': 'יעמידו',
    'o160030200071': 'זבי',
    'o160040070072': 'צחחיים',
    'o160040090132': 'נשוב',
    'o160050070161': 'נשאים',
    'o160050090022': 'יאמר',
    'o160070030022': 'יאמר',
    'o160090060061': 'את',
    'o160090170261': 'וחסד',
    'o160120460071': 'ראש',
    'o160130230101': 'אשדודיות',
    'o160130230121': 'עמוניות',
    'o130010110051': 'לודיים',
    'o130020160022': 'אחיתי',
    'o130030240041': 'הדיוהו',
    'o130070340052': 'רוהגה',
    'o130110170022': 'יתאו',
    'o130120160141': 'גדיתי',
    'o130140100081': 'פלשתיים',
    'o130150240101': 'מחצצרים',
    'o130180100092': 'שאול',
    'o130220070052': 'ו',
    'o130230090041': 'שלמות',
    'o130250010112': 'נביאים',
    'o130270290061': 'שטרי',
    'o140030170142': 'ימיני',
    'o140050120221': 'מחצררים',
    'o140050130042': 'מחצצרים',
    'o140070060231': 'מחצצרים',
    'o140080100042': 'נציבים',
    'o140080180071': 'אוניות',
    'o140110180081': 'בן',
    'o140130140121': 'מחצצרים',
    'o140170080082': 'שמרימות',
    'o140180080101': 'מיכהו',
    'o140260030151': 'יכיליה',
    'o140260070072': 'ערביים',
    'o140290080092': 'זועה',
    'o140290280081': 'מחצצרים',
    'o140310120101': 'כונניהו',
    'o140310130141': 'כונניהו',
    'o140320210213': 'יציאו',
    'o140330160022': 'יכן',
    'o140340060092': 'הרבתי',
    'o140340220121': 'תוקהת',
    'o140340250052': 'יקטירו',
    'o140350090022': 'כונניהו',
    'o140360170061': 'כשדיים',
    'o140360210131': 'ה', # TODO: 2x2
    'o140360210132': 'שמה',
}

def read_macula():
    book_order = ['01', '02', '03', '04', '05', # Pentateuch
                  '06', '07', '09', '10', '11', '12', # Former prophets
                  '23', '24', '26', # Major prophets
                  '28', '29', '30', '31', '32', '33', # Minor prophets
                  '34', '35', '36', '37', '38', '39', # Minor prophets
                  '19', '18', '20', # Wisdom
                  '08', '22', '21', '25', '17', '27',
                  '15', '16', '13', '14',]
    def nodes(pth):
        tree = ET.parse(pth).getroot()
        for node in tree.iter('m'):
            nid = node.attrib['{http://www.w3.org/XML/1998/namespace}id']
            yield (nid, macula_overrides.get(nid, clean(node.text)))
    for num in book_order:
        pth = f'/home/daniel/hbo-UD/macula-hebrew/WLC/nodes/{num}*'
        for book in sorted(glob.glob(pth)):
            yield from sorted(nodes(book))

def fuzzy_match(b, m):
    # replace vav with yod
    if m.replace('ו', 'י') == b.replace('ו', 'י'):
        return True
    if m.replace('ם', 'מ') == b.replace('ם', 'מ'):
        return True
    return False

overrides = {
}

bhsa = read_tf()
macula = read_macula()

b_queue = []
m_queue = []

errors = 0
with open('alignment.tsv', 'w') as fout:
    while True:
        try:
            if b_queue:
                bi, bw = b_queue.pop(0)
            else:
                bi, bw = next(bhsa)
            if m_queue:
                mi, mw = m_queue.pop(0)
            else:
                mi, mw = next(macula)
        except StopIteration:
            break
        if bw == mw or (bi, mi) in overrides:
            fout.write(f'{mi}\t{bi}\n')
        else:
            if bw and mw and bw[:-1] == mw[:-1] and bw[-1] == 'ו' and mw[-1] == 'י':
                mi2, mw2 = next(macula)
                if mw2 == 'ו':
                    fout.write(f'{mi}\t{bi}\n')
                    fout.write(f'{mi2}\t{bi}\n')
                    continue
                else:
                    m_queue.append((mi2, mw2))
            if len(bw) == len(mw) and fuzzy_match(bw, mw):
                fout.write(f'{mi}\t{bi}\n')
                continue
            if bw.startswith(mw):
                mi2, mw2 = next(macula)
                if bw == mw + mw2 or bw == mw + 'י' + mw2:
                    fout.write(f'{mi}\t{bi}\n')
                    fout.write(f'{mi2}\t{bi}\n')
                    continue
                elif bw == mw + 'ה' and mw2 == 'ו':
                    fout.write(f'{mi}\t{bi}\n')
                    fout.write(f'{mi2}\t{bi}\n')
                    continue
                elif bw == 'לא' and mw == 'ל' and mw2 == 'ו':
                    fout.write(f'{mi}\t{bi}\n')
                    fout.write(f'{mi2}\t{bi}\n')
                    continue
                elif bw == mw + 'נו' and mw2 == 'ני':
                    fout.write(f'{mi}\t{bi}\n')
                    fout.write(f'{mi2}\t{bi}\n')
                    continue
                elif bw == mw + 'יך' and mw2 == 'ך':
                    fout.write(f'{mi}\t{bi}\n')
                    fout.write(f'{mi2}\t{bi}\n')
                    continue
                else:
                    if bw.startswith(mw+mw2):
                        mi3, mw3 = next(macula)
                        if bw == mw + mw2 + mw3:
                            fout.write(f'{mi}\t{bi}\n')
                            fout.write(f'{mi2}\t{bi}\n')
                            fout.write(f'{mi3}\t{bi}\n')
                            continue
                        elif bw.startswith(mw + mw2 + mw3):
                            mi4, mw4 = next(macula)
                            if bw == mw + mw2 + mw3 + mw4:
                                fout.write(f'{mi}\t{bi}\n')
                                fout.write(f'{mi2}\t{bi}\n')
                                fout.write(f'{mi3}\t{bi}\n')
                                fout.write(f'{mi4}\t{bi}\n')
                                continue
                            else:
                                m_queue += [(mi2, mw2), (mi3, mw3), (mi4, mw4)]
                        else:
                            m_queue += [(mi2, mw2), (mi3, mw3)]
                    else:
                        m_queue.append((mi2, mw2))
            elif mw.startswith(bw):
                bi2, bw2 = next(bhsa)
                if mw == bw + bw2:
                    fout.write(f'{mi}\t{bi}\n')
                    fout.write(f'{mi}\t{bi2}\n')
                    continue
                else:
                    if mw.startswith(bw+bw2):
                        bi3, bw3 = next(bhsa)
                        if mw == bw + bw2 + bw3:
                            fout.write(f'{mi}\t{bi}\n')
                            fout.write(f'{mi}\t{bi2}\n')
                            fout.write(f'{mi}\t{bi3}\n')
                            continue
                        b_queue += [(bi2, bw2), (bi3, bw3)]
                    else:
                        b_queue.append((bi2, bw2))
            print(bi, bw, mi, mw)
            errors += 1
            if errors >= 10:
                break
